services:
  api_gateway:
    container_name: api_gateway
    build:
      context: ./api_gateway
      dockerfile: Dockerfile
    image: ib_mcp_api_gateway:v0.1
    ports:
      - "${GATEWAY_PORT}:${GATEWAY_PORT}"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    env_file:
      - .env
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
    networks:
      - mcp_net
    volumes:
      - ./api_gateway/conf.yaml:/app/api_gateway/root/conf.yaml
    healthcheck:
      test: ["CMD-SHELL", "curl -sk https://localhost:5055/v1/api/iserver/auth/status -o /dev/null"]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 20s

  mcp_server:
    container_name: mcp_server
    build:
      context: ./mcp_server
      dockerfile: Dockerfile
    image: ib_mcp_mcp_server:v0.0
    ports:
      - "${MCP_SERVER_PORT}:${MCP_SERVER_PORT}"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    env_file:
      - .env
    environment:
      - ROUTERS_PATH=/app/mcp_server/routers
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.3'
        reservations:
          memory: 128M
    depends_on:
      api_gateway:
        condition: service_healthy
    networks:
      - mcp_net
    volumes:
      - ./mcp_server:/app/mcp_server
    stdin_open: true
    tty: true
    restart: unless-stopped

  mcp_market_data:
    container_name: mcp_market_data
    build:
      context: ./mcp_market_data
      dockerfile: Dockerfile
    image: ib_mcp_market_data:v0.1
    ports:
      - "${MCP_MARKET_DATA_PORT}:${MCP_MARKET_DATA_PORT}"
    env_file:
      - .env
    environment:
      - MCP_HOST=0.0.0.0
      - MCP_PORT=${MCP_MARKET_DATA_PORT}
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
    networks:
      - mcp_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${MCP_MARKET_DATA_PORT}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped

  mcp_sentiment:
    container_name: mcp_sentiment
    build:
      context: ./mcp_sentiment
      dockerfile: Dockerfile
    image: ib_mcp_sentiment:v0.1
    ports:
      - "${MCP_SENTIMENT_PORT}:${MCP_SENTIMENT_PORT}"
    env_file:
      - .env
    environment:
      - MCP_HOST=0.0.0.0
      - MCP_PORT=${MCP_SENTIMENT_PORT}
      - MCP_SENTIMENT_INTERNAL_URL=http://mcp_sentiment:${MCP_SENTIMENT_PORT}
    deploy:
      resources:
        limits:
          memory: 384M
          cpus: '0.5'
        reservations:
          memory: 192M
    networks:
      - mcp_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${MCP_SENTIMENT_PORT}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped

  mcp_news:
    container_name: mcp_news
    build:
      context: ./mcp_news
      dockerfile: Dockerfile
    image: ib_mcp_news:v0.1
    ports:
      - "${MCP_NEWS_PORT}:${MCP_NEWS_PORT}"
    env_file:
      - .env
    environment:
      - MCP_HOST=0.0.0.0
      - MCP_PORT=${MCP_NEWS_PORT}
    deploy:
      resources:
        limits:
          memory: 384M
          cpus: '0.5'
        reservations:
          memory: 192M
    networks:
      - mcp_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${MCP_NEWS_PORT}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped

  telegram_bot:
    container_name: telegram_bot
    build:
      context: ./telegram_bot
      dockerfile: Dockerfile
    image: ib_mcp_telegram_bot:v0.1
    ports:
      - "${TELEGRAM_BOT_PORT}:${TELEGRAM_BOT_PORT}"
    env_file:
      - .env
    environment:
      - MCP_IB_URL=http://mcp_server:${MCP_SERVER_PORT}/mcp/
      - MCP_MARKET_DATA_URL=http://mcp_market_data:${MCP_MARKET_DATA_PORT}/mcp/mcp/
      - MCP_SENTIMENT_URL=http://mcp_sentiment:${MCP_SENTIMENT_PORT}/mcp/mcp/
      - MCP_NEWS_URL=http://mcp_news:${MCP_NEWS_PORT}/mcp/mcp/
      - DB_PATH=/data/trading.db
    deploy:
      resources:
        limits:
          memory: 384M
          cpus: '0.5'
        reservations:
          memory: 192M
    depends_on:
      mcp_market_data:
        condition: service_healthy
      mcp_sentiment:
        condition: service_healthy
      mcp_news:
        condition: service_healthy
    networks:
      - mcp_net
    volumes:
      - trading_data:/data
      - ./shared:/app/shared:ro
    restart: unless-stopped

networks:
  mcp_net:
    driver: bridge

volumes:
  trading_data:
